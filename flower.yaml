substitutions:
  name: flower
  fname: Flower
  manufacture: Kusheev Sergei
  device_description: "Flower systeme"
  version: 1.0.0
  # –≤—ã–≤–æ–¥—ã –∫ –∫–æ—Ç–æ—Ä—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ø–æ–º–ø—ã
  gpio_relay1: GPIO16
  gpio_relay2: GPIO17
  gpio_relay3: GPIO26
  gpio_relay4: GPIO27
  # –¥–∞—Ç—á–∏–∫ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è HC-SR04
  gpio_trigger_pin: GPIO13
  gpio_echo_pin: GPIO14
  fl1_mac: "5C:85:7E:13:D6:1F"
  fl2_mac: "5C:85:7E:13:D4:AB"
  fl3_mac: "5C:85:7E:13:D6:19"
  fl4_mac: "FF:FF:FF:FF:FF:FF"
globals:
  - id: flower1_mac
    type: std::string
    restore_value: true
    max_restore_data_length: 17
    initial_value: '"FF:FF:FF:FF:FF:FF"'
  - id: flower2_mac
    type: std::string
    restore_value: true
    max_restore_data_length: 17
    initial_value: '"FF:FF:FF:FF:FF:FF"'
  - id: flower3_mac
    type: std::string
    restore_value: true
    max_restore_data_length: 17
    initial_value: '"FF:FF:FF:FF:FF:FF"'
  - id: flower4_mac
    type: std::string
    restore_value: true
    max_restore_data_length: 17
    initial_value: '"FF:FF:FF:FF:FF:FF"'
  - id: flower_schedule
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: '"08:00"'
  - id: flower1_schedule
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: '"08:00"'
  - id: flower2_schedule
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: '"08:10"'
  - id: flower3_schedule
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: '"08:20"'
  - id: flower4_schedule
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: '"08:30"'
  - id: pump_run_time_1
    type: int
    restore_value: yes
    initial_value: '10'
  - id: pump_run_time_2
    type: int
    restore_value: yes
    initial_value: '10'
  - id: pump_run_time_3
    type: int
    restore_value: yes
    initial_value: '10'
  - id: pump_run_time_4
    type: int
    restore_value: yes
    initial_value: '10'
  - id: set_moisture_1
    type: int
    restore_value: yes
    initial_value: '50'
  - id: set_moisture_2
    type: int
    restore_value: yes
    initial_value: '50'
  - id: set_moisture_3
    type: int
    restore_value: yes
    initial_value: '50'
  - id: set_moisture_4
    type: int
    restore_value: yes
    initial_value: '50'
  - id: last_watering_zone1
    type: std::string
    restore_value: true
    max_restore_data_length: 20
    initial_value: '"‚Äî"'
  - id: last_watering_zone2
    type: std::string
    restore_value: true
    max_restore_data_length: 20
    initial_value: '"‚Äî"'
  - id: last_watering_zone3
    type: std::string
    restore_value: true
    max_restore_data_length: 20
    initial_value: '"‚Äî"'
  - id: last_watering_zone4
    type: std::string
    restore_value: true
    max_restore_data_length: 20
    initial_value: '"‚Äî"'





esphome:
  name: ${name}
  friendly_name: ${fname}
  comment: ${device_description}
  project:
    name: "immortalserg.flover"
    version: ${version}
  on_boot:
    priority: -10
    then:
      - lambda: |-
          auto parse_mac = [](std::string mac) -> uint64_t {
            uint64_t value = 0;
            int byte_val;
            for (int i = 0; i < 6; i++) {
              sscanf(mac.c_str() + i * 3, "%2x", &byte_val);
              value = (value << 8) | (byte_val & 0xFF);
            }
            return value;
          };
          ESP_LOGI("boot", "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ MAC –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ globals:");
          id(fl1).set_address(parse_mac(id(flower1_mac).c_str()));
          id(fl2).set_address(parse_mac(id(flower2_mac).c_str()));
          id(fl3).set_address(parse_mac(id(flower3_mac).c_str()));
          id(fl4).set_address(parse_mac(id(flower4_mac).c_str()));
      - lambda: |-
          id(pump_time_slider_1).publish_state(id(pump_run_time_1));
          id(pump_time_slider_2).publish_state(id(pump_run_time_2));
          id(pump_time_slider_3).publish_state(id(pump_run_time_3));
          id(pump_time_slider_4).publish_state(id(pump_run_time_4));

          id(set_moisture_slider_1).publish_state(id(set_moisture_1));
          id(set_moisture_slider_2).publish_state(id(set_moisture_2));
          id(set_moisture_slider_3).publish_state(id(set_moisture_3));
          id(set_moisture_slider_4).publish_state(id(set_moisture_4));


esp32:
  board: esp32dev
#  board: esp32-c3-devkitm-1
  framework:
    type: arduino


# Enable logging
logger:
  level: INFO
api:
  reboot_timeout: 0s
ota:
  - platform: esphome
    password: "b69751c0c1385709addd896571fc010e"
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Flower"
    password: "123456789"
captive_portal:
web_server:
  port: 80
  local: True  
  version: 3
#  log: False
  sorting_groups:
    - id: group1
      name: "üåø Flower1"
      sorting_weight: 10
    - id: group2
      name: "üåø Flower2"
      sorting_weight: 20
    - id: group3
      name: "üåø Flower3"
      sorting_weight: 30
    - id: group4
      name: "üåø Flower4"
      sorting_weight: 40
    - id: group5
      name: "‚öôÔ∏è Setting"
      sorting_weight: 60
    - id: group6
      name: "üìä Sensor"
      sorting_weight: 45
    - id: group7
      name: "‚öôÔ∏è Flower1 Setting"
      sorting_weight: 46
    - id: group8
      name: "‚öôÔ∏è Flower2 Setting"
      sorting_weight: 47
    - id: group9
      name: "‚öôÔ∏è Flower3 Setting"
      sorting_weight: 48
    - id: group10
      name: "‚öôÔ∏è Flower4 Setting"
      sorting_weight: 49
  

esp32_ble:
  disable_bt_logs: true
  connection_timeout: 20s 
  max_connections: 4
esp32_ble_tracker:
# 5C:85:7E:13:D6:1F






#bluetooth_proxy:
#  active: true
#  connection_slots: 4

script:
  - id: pump_on_zone_1
    then:
      - switch.turn_on: relay_1
      - delay: !lambda 'return id(pump_run_time_1) * 1000;'
      - switch.turn_off: relay_1
      - lambda: |-
          ESP_LOGI("pump", "–ù–∞—Å–æ—Å –ó–æ–Ω–∞ 1 –≤—ã–∫–ª—é—á–µ–Ω –ø–æ —Ç–∞–π–º–µ—Ä—É");

  - id: pump_on_zone_2
    then:
      - switch.turn_on: relay_2
      - delay: !lambda 'return id(pump_run_time_2) * 1000;'
      - switch.turn_off: relay_2
      - lambda: |-
          ESP_LOGI("pump", "–ù–∞—Å–æ—Å –ó–æ–Ω–∞ 2 –≤—ã–∫–ª—é—á–µ–Ω –ø–æ —Ç–∞–π–º–µ—Ä—É");

  - id: pump_on_zone_3
    then:
      - switch.turn_on: relay_3
      - delay: !lambda 'return id(pump_run_time_3) * 1000;'
      - switch.turn_off: relay_3
      - lambda: |-
          ESP_LOGI("pump", "–ù–∞—Å–æ—Å –ó–æ–Ω–∞ 3 –≤—ã–∫–ª—é—á–µ–Ω –ø–æ —Ç–∞–π–º–µ—Ä—É");

  - id: pump_on_zone_4
    then:
      - switch.turn_on: relay_4
      - delay: !lambda 'return id(pump_run_time_4) * 1000;'
      - switch.turn_off: relay_4
      - lambda: |-
          ESP_LOGI("pump", "–ù–∞—Å–æ—Å –ó–æ–Ω–∞ 4 –≤—ã–∫–ª—é—á–µ–Ω –ø–æ —Ç–∞–π–º–µ—Ä—É");




text:
  - platform: template
    name: "MAC"
    id: flower1_mac_text
    mode: text
    icon: mdi:bluetooth
    lambda: |-
      return id(flower1_mac);
    set_action:
      - lambda: |-
          if (x.size() == 17) {
            id(flower1_mac) = x;
            ESP_LOGI("BLE", "–ù–æ–≤—ã–π MAC Flower1: %s", x.c_str());
          } else {
            ESP_LOGW("BLE", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π MAC: %s", x.c_str());
          }
    web_server:
      sorting_group_id: group7

  - platform: template
    name: "MAC "
    id: flower2_mac_text
    mode: text
    icon: mdi:bluetooth
    lambda: |-
      return id(flower2_mac);
    set_action:
      - lambda: |-
          if (x.size() == 17) {
            id(flower2_mac) = x;
            ESP_LOGI("BLE", "–ù–æ–≤—ã–π MAC Flower2: %s", x.c_str());
          } else {
            ESP_LOGW("BLE", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π MAC: %s", x.c_str());
          }
    web_server:
      sorting_group_id: group8

  - platform: template
    name: "MAC  "
    id: flower3_mac_text
    mode: text
    icon: mdi:bluetooth
    lambda: |-
      return id(flower3_mac);
    set_action:
      - lambda: |-
          if (x.size() == 17) {
            id(flower3_mac) = x;
            ESP_LOGI("BLE", "–ù–æ–≤—ã–π MAC Flower3: %s", x.c_str());
          } else {
            ESP_LOGW("BLE", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π MAC: %s", x.c_str());
          }
    web_server:
      sorting_group_id: group9

  - platform: template
    name: "MAC   "
    id: flower4_mac_text
    mode: text
    icon: mdi:bluetooth
    lambda: |-
      return id(flower4_mac);
    set_action:
      - lambda: |-
          if (x.size() == 17) {
            id(flower4_mac) = x;
            ESP_LOGI("BLE", "–ù–æ–≤—ã–π MAC Flower4: %s", x.c_str());
          } else {
            ESP_LOGW("BLE", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π MAC: %s", x.c_str());
          }
    web_server:
      sorting_group_id: group10
  - platform: template
    name: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
    id: flower1_schedule_text
    icon: "mdi:calendar-clock"
    mode: text
    lambda: |-
      return id(flower1_schedule);
    set_action:
      then:
        - lambda: |-
            ESP_LOGI("schedule", "–ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower1: %s", x.c_str());
            id(flower1_schedule) = x;
    web_server:
      sorting_group_id: group7

  - platform: template
    name: "–†–∞—Å–ø–∏—Åa–Ω–∏–µ"
    id: flower2_schedule_text
    icon: "mdi:calendar-clock"
    mode: text
    lambda: |-
      return id(flower2_schedule);
    set_action:
      then:
        - lambda: |-
            ESP_LOGI("schedule", "–ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower2: %s", x.c_str());
            id(flower2_schedule) = x;
    web_server:
      sorting_group_id: group8

  - platform: template
    name: "–†a—Å–ø–∏—Å–∞–Ω–∏–µ"
    id: flower3_schedule_text
    icon: "mdi:calendar-clock"
    mode: text
    lambda: |-
      return id(flower3_schedule);
    set_action:
      then:
        - lambda: |-
            ESP_LOGI("schedule", "–ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower3: %s", x.c_str());
            id(flower3_schedule) = x;
    web_server:
      sorting_group_id: group9

  - platform: template
    name: "–†a—Å–ø–∏—Åa–Ω–∏–µ"
    id: flower4_schedule_text
    icon: "mdi:calendar-clock"
    mode: text
    lambda: |-
      return id(flower4_schedule);
    set_action:
      then:
        - lambda: |-
            ESP_LOGI("schedule", "–ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower4: %s", x.c_str());
            id(flower4_schedule) = x;
    web_server:
      sorting_group_id: group10


number:
  # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã
  - platform: template
    name: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞"
    id: pump_time_slider_1
    optimistic: true
    restore_value: true
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    icon: mdi:timer-outline
    web_server:
      sorting_group_id: group7
    set_action:
      - lambda: |-
          id(pump_run_time_1) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞ –ó–æ–Ω–∞ 1: %d —Å–µ–∫—É–Ω–¥", (int)x);

  - platform: template
    name: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤a"
    id: pump_time_slider_2
    optimistic: true
    restore_value: true
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    icon: mdi:timer-outline
    web_server:
      sorting_group_id: group8
    set_action:
      - lambda: |-
          id(pump_run_time_2) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞ –ó–æ–Ω–∞ 2: %d —Å–µ–∫—É–Ω–¥", (int)x);

  - platform: template
    name: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –øo–ª–∏–≤–∞"
    id: pump_time_slider_3
    optimistic: true
    restore_value: true
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    icon: mdi:timer-outline
    web_server:
      sorting_group_id: group9
    set_action:
      - lambda: |-
          id(pump_run_time_3) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞ –ó–æ–Ω–∞ 3: %d —Å–µ–∫—É–Ω–¥", (int)x);

  - platform: template
    name: "–ü—Ä–æ–¥o–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞"
    id: pump_time_slider_4
    optimistic: true
    restore_value: true
    min_value: 1
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    icon: mdi:timer-outline
    web_server:
      sorting_group_id: group10
    set_action:
      - lambda: |-
          id(pump_run_time_4) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞—Å–æ—Å–∞ –ó–æ–Ω–∞ 4: %d —Å–µ–∫—É–Ω–¥", (int)x);

  # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã
  - platform: template
    name: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å"
    id: set_moisture_slider_1
    optimistic: true
    restore_value: true
    min_value: 20
    max_value: 60
    step: 1
    unit_of_measurement: "%"
    icon: mdi:water-percent
    web_server:
      sorting_group_id: group7
    set_action:
      - lambda: |-
          id(set_moisture_1) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ó–æ–Ω–∞ 1: %d –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤", (int)x);

  - platform: template
    name: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤a—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å"
    id: set_moisture_slider_2
    optimistic: true
    restore_value: true
    min_value: 20
    max_value: 60
    step: 1
    unit_of_measurement: "%"
    icon: mdi:water-percent
    web_server:
      sorting_group_id: group8
    set_action:
      - lambda: |-
          id(set_moisture_2) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ó–æ–Ω–∞ 2: %d –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤", (int)x);

  - platform: template
    name: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ªa–∂–Ω–æ—Å—Ç—å"
    id: set_moisture_slider_3
    optimistic: true
    restore_value: true
    min_value: 20
    max_value: 60
    step: 1
    unit_of_measurement: "%"
    icon: mdi:water-percent
    web_server:
      sorting_group_id: group9
    set_action:
      - lambda: |-
          id(set_moisture_3) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ó–æ–Ω–∞ 3: %d –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤", (int)x);

  - platform: template
    name: "–üo–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å"
    id: set_moisture_slider_4
    optimistic: true
    restore_value: true
    min_value: 20
    max_value: 60
    step: 1
    unit_of_measurement: "%"
    icon: mdi:water-percent
    web_server:
      sorting_group_id: group10
    set_action:
      - lambda: |-
          id(set_moisture_4) = x;
          ESP_LOGI("pump", "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ó–æ–Ω–∞ 4: %d –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤", (int)x);


  - platform: template
    name: "–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –±–∞–∫–∞"
    id: full_tank_distance
    min_value: 0
    max_value: 1000
    step: 1
    unit_of_measurement: "mm"
    optimistic: true
    restore_value: true
    initial_value: 50
    web_server:
      sorting_group_id: group5

  - platform: template
    name: "–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ –±–∞–∫a"
    id: empty_tank_distance
    min_value: 0
    max_value: 1000
    step: 1
    unit_of_measurement: "mm"
    optimistic: true
    restore_value: true
    initial_value: 500
    web_server:
      sorting_group_id: group5





sensor:
  - platform: ultrasonic
    trigger_pin: $gpio_trigger_pin
    echo_pin: $gpio_echo_pin
    name: 'Ultrasonic Sensor'
    id: ultrasonic_sensor
    update_interval: 1s
    accuracy_decimals: 3
    unit_of_measurement: m
    web_server: 
      sorting_group_id: group6
  - platform: template
    name: "Ultrasonic Sensor (mm)"
    id: ultrasonic_sensor_mm
    unit_of_measurement: "mm"
    accuracy_decimals: 0
    update_interval: 1s
    lambda: |-
      if (isnan(id(ultrasonic_sensor).state)) {
        return NAN;
      }
      return id(ultrasonic_sensor).state * 1000.0;
    web_server:
      sorting_group_id: group6

  - platform: template
    name: "–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã –≤ –±–∞–∫–µ"
    id: water_level_percent
    unit_of_measurement: "%"
    accuracy_decimals: 0
    update_interval: 1s
    lambda: |-
      float full = id(full_tank_distance).state;
      float empty = id(empty_tank_distance).state;
      float dist = id(ultrasonic_sensor_mm).state;

      if (isnan(dist) || full >= empty) {
        return NAN;  // –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      }

      float level = (empty - dist) / (empty - full) * 100.0;

      if (level < 0) level = 0;
      if (level > 100) level = 100;

      return level;
    web_server:
      sorting_group_id: group6
    
  # --- Flower 1 ---
  - platform: xiaomi_hhccjcy01
    mac_address: $fl1_mac
    id: fl1
    temperature:
      id: f1_temp
      name: "Temperature"
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group1
    moisture:
      id: f1_moist
      name: "Moisture"
      icon: mdi:water-percent
      web_server:
        sorting_group_id: group1
    illuminance:
      id: f1_lux
      name: "Illuminance"
      icon: mdi:white-balance-sunny
      web_server:
        sorting_group_id: group1
    conductivity:
      id: f1_cond
      name: "Soil Conductivity"
      icon: mdi:flash
      web_server:
        sorting_group_id: group1
    battery_level:
      id: f1_batt
      name: "Battery"
      icon: mdi:battery
      web_server:
        sorting_group_id: group1
  # --- Flower 2 ---
  - platform: xiaomi_hhccjcy01
    mac_address: $fl2_mac
    id: fl2
    temperature:
      id: f2_temp
      name: "Temperature "
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group2
    moisture:
      id: f2_moist
      name: "Moisture "
      icon: mdi:water-percent
      web_server:
        sorting_group_id: group2
    illuminance:
      id: f2_lux
      name: "Illuminance "
      icon: mdi:white-balance-sunny
      web_server:
        sorting_group_id: group2
    conductivity:
      id: f2_cond
      name: "Soil Conductivity "
      icon: mdi:flash
      web_server:
        sorting_group_id: group2
    battery_level:
      id: f2_batt
      name: "Battery "
      icon: mdi:battery
      web_server:
        sorting_group_id: group2
  # --- Flower 3 ---
  - platform: xiaomi_hhccjcy01
    mac_address: $fl3_mac
    id: fl3
    temperature:
      id: f3_temp
      name: "Temperature  "
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group3
    moisture:
      id: f3_moist
      name: "Moisture  "
      icon: mdi:water-percent
      web_server:
        sorting_group_id: group3
    illuminance:
      id: f3_lux
      name: "Illuminance  "
      icon: mdi:white-balance-sunny
      web_server:
        sorting_group_id: group3
    conductivity:
      id: f3_cond
      name: "Soil Conductivity  "
      icon: mdi:flash
      web_server:
        sorting_group_id: group3
    battery_level:
      id: f3_batt
      name: "Battery  "
      icon: mdi:battery
      web_server:
        sorting_group_id: group3
  # --- Flower 4 ---
  - platform: xiaomi_hhccjcy01
    mac_address: $fl4_mac
    id: fl4
    temperature:
      id: f4_temp
      name: "Temperature   "
      icon: mdi:thermometer
      web_server:
        sorting_group_id: group4
    moisture:
      id: f4_moist
      name: "Moisture   "
      icon: mdi:water-percent
      web_server:
        sorting_group_id: group4
    illuminance:
      id: f4_lux
      name: "Illuminance   "
      icon: mdi:white-balance-sunny
      web_server:
        sorting_group_id: group4
    conductivity:
      id: f4_cond
      name: "Soil Conductivity   "
      icon: mdi:flash
      web_server:
        sorting_group_id: group4
    battery_level:
      id: f4_batt
      name: "Battery   "
      icon: mdi:battery
      web_server:
        sorting_group_id: group4







switch:
  - platform: gpio
    pin: $gpio_relay1
    name: "–ø–æ–º–ø–∞"
    id: relay_1
    icon: "mdi:pump"
    restore_mode: RESTORE_DEFAULT_OFF
    web_server:
      sorting_group_id: group1
    on_turn_on:
      - lambda: |-
          id(last_watering_zone1) = id(sntp_time).now().strftime("%Y-%m-%d %H:%M");
          id(last_watering_sensor_1).publish_state(id(last_watering_zone1));

  - platform: gpio
    pin: $gpio_relay2
    name: "–øo–º–ø–∞"
    id: relay_2
    icon: "mdi:pump"
    restore_mode: RESTORE_DEFAULT_OFF
    web_server:
      sorting_group_id: group2
    on_turn_on:
      - lambda: |-
          id(last_watering_zone2) = id(sntp_time).now().strftime("%Y-%m-%d %H:%M");
          id(last_watering_sensor_2).publish_state(id(last_watering_zone2));

  - platform: gpio
    pin: $gpio_relay3
    name: "–ø–æ–º–øa"
    id: relay_3
    icon: "mdi:pump"
    restore_mode: RESTORE_DEFAULT_OFF
    web_server:
      sorting_group_id: group3
    on_turn_on:
      - lambda: |-
          id(last_watering_zone3) = id(sntp_time).now().strftime("%Y-%m-%d %H:%M");
          id(last_watering_sensor_3).publish_state(id(last_watering_zone3));

  - platform: gpio
    pin: $gpio_relay4
    name: "–øo–º–øa"
    id: relay_4
    icon: "mdi:pump"
    restore_mode: RESTORE_DEFAULT_OFF
    web_server:
      sorting_group_id: group4
    on_turn_on:
      - lambda: |-
          id(last_watering_zone4) = id(sntp_time).now().strftime("%Y-%m-%d %H:%M");
          id(last_watering_sensor_4).publish_state(id(last_watering_zone4));

  - platform: template
    name: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"
    id: flower1_schedule_enable
    web_server:
      sorting_group_id: group7
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower1 –≤–∫–ª—é—á–µ–Ω–æ"
    turn_off_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower1 –≤—ã–∫–ª—é—á–µ–Ω–æ"

  - platform: template
    name: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ωo"
    id: flower2_schedule_enable
    web_server:
      sorting_group_id: group8
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower2 –≤–∫–ª—é—á–µ–Ω–æ"
    turn_off_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower2 –≤—ã–∫–ª—é—á–µ–Ω–æ"

  - platform: template
    name: "–†a—Å–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"
    id: flower3_schedule_enable
    web_server:
      sorting_group_id: group9
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower3 –≤–∫–ª—é—á–µ–Ω–æ"
    turn_off_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower3 –≤—ã–∫–ª—é—á–µ–Ω–æ"

  - platform: template
    name: "–†–∞—Å–ø–∏—Åa–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"
    id: flower4_schedule_enable
    web_server:
      sorting_group_id: group10
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower4 –≤–∫–ª—é—á–µ–Ω–æ"
    turn_off_action:
      - logger.log: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ Flower4 –≤—ã–∫–ª—é—á–µ–Ω–æ"


text_sensor:
  - platform: template
    name: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤"
    id: last_watering_sensor_1
    icon: mdi:clock
    web_server:
      sorting_group_id: group1
  - platform: template
    name: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –øo–ª–∏–≤"
    id: last_watering_sensor_2
    icon: mdi:clock
    web_server:
      sorting_group_id: group2
  - platform: template
    name: "–üo—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤"
    id: last_watering_sensor_3
    icon: mdi:clock
    web_server:
      sorting_group_id: group3
  - platform: template
    name: "–üo—Å–ª–µ–¥–Ω–∏–π –øo–ª–∏–≤"
    id: last_watering_sensor_4
    icon: mdi:clock
    web_server:
      sorting_group_id: group4

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Luxembourg
    on_time:
      - seconds: 0
        minutes: "*"
        hours: "*"
        then:
          - lambda: |-
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –∑–æ–Ω–∞–º
              if (!id(flower1_schedule_enable).state &&
                  !id(flower2_schedule_enable).state &&
                  !id(flower3_schedule_enable).state &&
                  !id(flower4_schedule_enable).state) {
                ESP_LOGD("watering", "–í—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏.");
                return;
              }

              auto now = id(sntp_time).now();
              if (!now.is_valid()) return;

              char current_time[6];
              sprintf(current_time, "%02d:%02d", now.hour, now.minute);

              // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–æ–Ω—ã
              struct Zone {
                esphome::sensor::Sensor *sensor;
                const char *name;
                int moisture_target;
                std::string schedule;
                std::function<void()> run_pump;
                bool enabled;
              };

              Zone zones[] = {
                { id(f1_moist), "–ó–æ–Ω–∞ 1", id(set_moisture_1), id(flower1_schedule), []() { id(pump_on_zone_1).execute(); }, id(flower1_schedule_enable).state },
                { id(f2_moist), "–ó–æ–Ω–∞ 2", id(set_moisture_2), id(flower2_schedule), []() { id(pump_on_zone_2).execute(); }, id(flower2_schedule_enable).state },
                { id(f3_moist), "–ó–æ–Ω–∞ 3", id(set_moisture_3), id(flower3_schedule), []() { id(pump_on_zone_3).execute(); }, id(flower3_schedule_enable).state },
                { id(f4_moist), "–ó–æ–Ω–∞ 4", id(set_moisture_4), id(flower4_schedule), []() { id(pump_on_zone_4).execute(); }, id(flower4_schedule_enable).state },
              };

              for (auto &z : zones) {
                if (!z.enabled) {
                  ESP_LOGD("watering", "%s: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º", z.name);
                  continue;
                }

                std::string schedule = z.schedule;
                bool match = false;

                size_t start = 0;
                while (true) {
                  size_t end = schedule.find(';', start);
                  std::string token = schedule.substr(start, end - start);
                  token.erase(remove_if(token.begin(), token.end(), ::isspace), token.end());
                  if (token == current_time) {
                    match = true;
                    break;
                  }
                  if (end == std::string::npos) break;
                  start = end + 1;
                }

                if (!match) continue;

                float moist = z.sensor->state;
                if (isnan(moist)) {
                  ESP_LOGW("watering", "%s: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞", z.name);
                  continue;
                }

                if (moist < z.moisture_target) {
                  ESP_LOGI("watering", "%s: –≤–ª–∞–∂–Ω–æ—Å—Ç—å %.1f < %d ‚Äî –≤–∫–ª—é—á–∞–µ–º –Ω–∞—Å–æ—Å", z.name, moist, z.moisture_target);
                  z.run_pump();
                } else {
                  ESP_LOGD("watering", "%s: –≤–ª–∞–∂–Ω–æ—Å—Ç—å %.1f >= %d ‚Äî –Ω–∞—Å–æ—Å –Ω–µ –≤–∫–ª—é—á–∞–µ–º", z.name, moist, z.moisture_target);
                }
              }
